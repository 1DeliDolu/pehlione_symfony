{% extends 'base.html.twig' %}

{% block title %}Ticket #{{ "%06d"|format(thread.id) }} - Pehlione{% endblock %}

{% block body %}
<div class="mx-auto max-w-5xl px-4 py-10 space-y-6">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <a href="{{ path('account_mail') }}" class="text-sm text-indigo-600 hover:underline">← Mail'e dön</a>
            <h1 class="text-2xl font-semibold text-gray-900 mt-2">{{ thread.subject }}</h1>
            <div class="mt-1 text-sm text-gray-600">
                <span class="mr-3">#{{ "%06d"|format(thread.id) }}</span>
                <span class="mr-3">Birim: {{ thread.department.name }}</span>
                <span class="mr-3">Durum: {{ thread.status }}</span>
                <span>Tip: {{ thread.type }}</span>
            </div>
        </div>
    </div>

    {% for label, messages in app.flashes %}
        {% for msg in messages %}
            <div class="rounded-lg border px-4 py-3 text-sm {% if label == 'success' %}border-green-200 bg-green-50 text-green-800{% else %}border-red-200 bg-red-50 text-red-800{% endif %}">
                {{ msg }}
            </div>
        {% endfor %}
    {% endfor %}

    <section class="space-y-4">
        <div class="rounded-xl border border-gray-200 bg-white p-5">
            <div class="flex items-center justify-between text-sm text-gray-600">
                <div>
                    {% if thread.createdBy %}
                        {{ thread.createdBy.name ?? thread.createdBy.email }}
                    {% else %}
                        {{ thread.customerName ?? thread.customerEmail ?? 'Misafir' }}
                    {% endif %}
                </div>
                <div>{{ thread.createdAt|date('d.m.Y H:i') }}</div>
            </div>
            <div class="mt-3 whitespace-pre-wrap text-gray-900">{{ thread.message }}</div>
        </div>

        {% for reply in thread.replies %}
            {% if not reply.internal or (app.user and app.user.isStaff()) %}
                <div class="rounded-xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center justify-between text-sm text-gray-600">
                        <div>
                            {{ reply.author ? (reply.author.name ?? reply.author.email) : 'Sistem' }}
                            {% if reply.internal %}
                                <span class="ml-2 inline-flex rounded-full border border-yellow-200 bg-yellow-50 px-2 py-0.5 text-xs text-yellow-800">İç Not</span>
                            {% endif %}
                        </div>
                        <div>{{ reply.createdAt|date('d.m.Y H:i') }}</div>
                    </div>
                    <div class="mt-3 whitespace-pre-wrap text-gray-900">{{ reply.body }}</div>
                </div>
            {% endif %}
        {% endfor %}
    </section>

    {% if is_granted('SUPPORT_THREAD_REPLY', thread) %}
        <section class="rounded-xl border border-gray-200 bg-white p-5">
            <h2 class="text-lg font-semibold text-gray-900 mb-3">Yanıt Yaz</h2>
            {{ form_start(form, {'attr': {'class': 'space-y-4'}}) }}
                <div>
                    {{ form_label(form.body, 'Mesaj', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                    <div class="mt-2">
                        {{ form_widget(form.body, {'attr': {'class': 'w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-2 focus:outline-indigo-600'}}) }}
                    </div>
                    {{ form_errors(form.body) }}
                </div>

                {% if app.user and app.user.isStaff() %}
                    <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                        {{ form_widget(form.internal) }}
                        <span>İç not</span>
                    </label>
                {% endif %}

                <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500">
                    Gönder
                </button>
                {{ form_widget(form._token) }}
            {{ form_end(form, {'render_rest': false}) }}
        </section>
    {% else %}
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-5 text-sm text-gray-600">
            Bu ticket için yanıt verme yetkiniz yok veya ticket kapalı.
        </div>
    {% endif %}
</div>
{% endblock %}
